name: build-daemon
on:
  push:
    paths:
      - 'packages/daemon/**'
      - '.github/workflows/build-daemon.yml'
  pull_request:
    paths:
      - 'packages/daemon/**'
      - '.github/workflows/build-daemon.yml'
  workflow_dispatch: {}
  workflow_call: {}

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-13, windows-2022]
        build_type: [Release]
    runs-on: ${{ matrix.os }}

    env:
      CMAKE_BUILD_TYPE: ${{ matrix.build_type }}
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      CMAKE_TOOLCHAIN_FILE: ${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake

    steps:
      - uses: actions/checkout@v4

      # ---------- vcpkg clone + bootstrap ----------
      - name: Clone vcpkg (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: git clone https://github.com/microsoft/vcpkg "$VCPKG_ROOT"

      - name: Clone vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: git clone https://github.com/microsoft/vcpkg $env:VCPKG_ROOT

      - name: Bootstrap vcpkg (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: "$VCPKG_ROOT/bootstrap-vcpkg.sh"

      - name: Bootstrap vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: '& "$env:VCPKG_ROOT\bootstrap-vcpkg.bat"'

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.VCPKG_ROOT }}/installed
            ${{ env.VCPKG_ROOT }}/buildtrees
            ${{ env.VCPKG_ROOT }}/packages
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('packages/daemon/vcpkg.json') }}

      # ---------- Clean build dir ----------
      - name: Clean build dir (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: rm -rf build

      - name: Clean build dir (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue

      # ---------- Configure (CMake) ----------
      - name: Configure (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: >
          cmake -S packages/daemon -B build
          -G "Unix Makefiles"
          -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }}
          -DCMAKE_TOOLCHAIN_FILE=${{ env.CMAKE_TOOLCHAIN_FILE }}

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: >
          cmake -S packages/daemon -B build
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }}
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake"

      # ---------- Build ----------
      - name: Build (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: cmake --build build --config ${{ env.CMAKE_BUILD_TYPE }} -j 4

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: cmake --build build --config $env:CMAKE_BUILD_TYPE -- /m

      # ---------- Package artifacts ----------
      - name: Package artifact
        shell: bash
        run: |
          mkdir -p dist
          if [ "$RUNNER_OS" = "Windows" ]; then
            cp "build/${{ env.CMAKE_BUILD_TYPE }}/sumo-daemon.exe" "dist/sumo-daemon-windows-amd64.exe"
          elif [ "$RUNNER_OS" = "macOS" ]; then
            cp build/sumo-daemon dist/sumo-daemon-darwin-amd64
          else
            cp build/sumo-daemon dist/sumo-daemon-linux-amd64
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: sumo-daemon-${{ runner.os }}
          path: dist/*
